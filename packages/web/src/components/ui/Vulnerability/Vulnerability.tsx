import React from 'react';
import clsx from 'clsx';
import TagBadge from '../TagBadge/TagBadge';
import styles from './Vulnerability.module.scss';
import { External } from '../../icons';

export enum VulnerabilitySeverity {
  CRITICAL = 'CRITICAL',
  HIGH = 'HIGH',
  MODERATE = 'MODERATE',
  LOW = 'LOW',
  UNKNOWN = 'UNKNOWN',
}

export type PackageVulnerabilityData = {
  affectedPackageName: string;
  affectedVersionRange: string;
  osvId: string;
  detailsUrl: string;
  summary?: string;
  severity?: string;
};

export type Props = {
  vulnerability: PackageVulnerabilityData;
};

export default function Vulnerability({ vulnerability }: Props) {
  return (
    <div className={styles.vulnerability}>
      {!!vulnerability.detailsUrl && (
        <a
          className={clsx(styles.vulnerabilityDataColumn, styles.inlineIcon)}
          href={vulnerability.detailsUrl}
          target='_blank'
          rel='noreferrer'
        >
          <External />
        </a>
      )}

      <span className={styles.vulnerabilityDataColumn}>
        <VulnerabilitySeverityTagBadge severity={vulnerability.severity} />
        &nbsp;
        {vulnerability.osvId}
      </span>

      <span className={clsx(styles.vulnerabilityDataColumn, styles.vulnerabilitySummary)}>
        {vulnerability.summary}
      </span>
      <span className={styles.vulnerabilityDataColumn}>{vulnerability.affectedVersionRange}</span>
    </div>
  );
}

export type VulnerabilitySeverityTagBadgeProps = {
  severity?: string;
};

const SeverityColorMapping: Record<string, string> = {
  [VulnerabilitySeverity.CRITICAL]: 'red',
  [VulnerabilitySeverity.HIGH]: 'red',
  [VulnerabilitySeverity.MODERATE]: 'yellow',
  [VulnerabilitySeverity.LOW]: 'gray',
  [VulnerabilitySeverity.UNKNOWN]: 'gray',
};

function VulnerabilitySeverityTagBadge({ severity }: VulnerabilitySeverityTagBadgeProps) {
  const formattedSeverity = severity ? severity.toUpperCase() : 'UNKNOWN';

  return <TagBadge color={SeverityColorMapping[formattedSeverity]}>{formattedSeverity}</TagBadge>;
}

export const SeverityWeightMap: Record<string, number> = {
  [VulnerabilitySeverity.CRITICAL]: 4,
  [VulnerabilitySeverity.HIGH]: 3,
  [VulnerabilitySeverity.MODERATE]: 2,
  [VulnerabilitySeverity.LOW]: 1,
  [VulnerabilitySeverity.UNKNOWN]: 0,
};
